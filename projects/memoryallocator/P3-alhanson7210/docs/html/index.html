<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.16"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Memory Allocator: Project 3: Memory Allocator</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Memory Allocator
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.16 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'Search');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Project 3: Memory Allocator </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>See: <a href="https://www.cs.usfca.edu/~mmalensek/cs326/assignments/project-3.html">https://www.cs.usfca.edu/~mmalensek/cs326/assignments/project-3.html</a></p>
<p><em>Writer: Alex Hanson</em></p>
<p>University of San Francisco</p>
<p>CS 326 Operating Systems</p>
<h1><a class="anchor" id="autotoc_md1"></a>
About This Project:</h1>
<p><em>CREATING A MEMORY ALLOCATOR FOR MEMORY MANAGEMENT FOR AN OPERATING SYSTEM BY USING OR CREATING THE NECESSARY SYSTEM CALLS TO ALLOCATE AND FREE MEMORY ACCORDINGLY</em></p>
<p><em>Memory Allocator</em> </p><blockquote class="doxtable">
<p>The program allocates a page of space or reuses a given block of pre-allocated memory that the user will use based of a given request size which will also have the <a class="el" href="structmem__block.html">mem_block</a> attached before that allocated memory request </p>
</blockquote>
<p><em>Managing Memory</em> </p><blockquote class="doxtable">
<p>In order to keep track of memory when a user wants to free or malloc memory(et al) is done by have a linked list of memory that memory blocks get added or deleted from. First fit: looks for the first block size that fits the memory request Best fit: looks for the minimum block size that fits the memory request Worst fit: looks for the maximum block size that fits the memory request <br  />
 </p>
</blockquote>
<p><em>Allocating Memory</em> </p><blockquote class="doxtable">
<p>MMAP is used to allocate memory more flexibly than sbrk or brk, but it also requires more parameters to be filled. Overflow is checked in calloc, M_MMAP_THRESHOLD is is checked for in malloc, and ENOMEM can additional handled in realloc, and lastly you can check for SIZE_MAX if a memory request is too large as well </p>
</blockquote>
<p><em>Freeing Memory</em> </p><blockquote class="doxtable">
<p>The way freeing is managed is by checking a block of memory to see if it is g_head or not If it is, this requires going through the linked list and simultaneously checking the region for all its blocks having a usage of 0. If at any point the usage doesn't equal zero, simply return; otherwise, the region actual has to be unmmapped. If it's not g_head, this requires finding the previous regions last block and the the next regions first block. If at any point the usage doesn't equal zero, simply return; otherwise, the region actual has to be unmmapped as well. Depending on the case, g_head or some other randomly placed block is unmapped, and the linked list is fixed in place </p>
</blockquote>
<p><em>Reallocating Memory</em> </p><blockquote class="doxtable">
<p>If the block can be resized in place, we can simply change the usage; otherwise we need to malloc space for a new block, copy the old one to the new, free the old one, and return the new </p>
</blockquote>
<p><em>Basic Functionality Overview</em> </p><div class="fragment"><div class="line">1. Simple allocator (one block per region)</div>
<div class="line">2. print_memory() function</div>
<div class="line">3. Verified(correct) linked list sequence and visualization</div>
<div class="line">4. Scribbling</div>
<div class="line">5. Free space management algorithms</div>
</div><!-- fragment --><p><em>Extra Features</em> </p><blockquote class="doxtable">
<p>Named Blocks: to help with debugging, you can optionally provide a name for each allocation. These names will be shown when state information is printed. Memory State Information: your allocator should be able to print out the current state of the regions and blocks with the <a class="el" href="allocator_8c.html#a16e4f54f08fa2ef1574b413d64a94d44" title="Prints out the current memory state, including both the regions and blocks. Entries are printed in or...">print_memory()</a> function. See the format below: File Logging: You should also be able to write the same contents printed by print_memory to a file. Scribbling: <a class="el" href="allocator_8c.html#afbedc913aa4651b3c3b4b3aecd9b4711" title="set usage to zero or unmap memory region">free()</a> leaves old values in memory without cleaning them up. When the ALLOCATOR_SCRIBBLE environment variable is set to 1, you will fill any new allocation with 0xAA (10101010 in binary). This means that if a program assumes memory allocated by malloc is zeroed out, it will crash </p>
</blockquote>
<h1><a class="anchor" id="autotoc_md2"></a>
Visualizations:</h1>
<div class="fragment"><div class="line">-- Current Memory State --</div>
<div class="line">[REGION] 0x7fdb7f7cc000-0x7fdb7f7cd000 4096</div>
<div class="line">[BLOCK]  0x7fdb7f7cc000-0x7fdb7f7cc248 (0) &#39;Test Allocation: 0&#39; 584 584 504</div>
<div class="line">[BLOCK]  0x7fdb7f7cc248-0x7fdb7f7cc4f0 (5) &#39;Test Allocation: 5&#39; 680 680 600</div>
<div class="line">[BLOCK]  0x7fdb7f7cc4f0-0x7fdb7f7cc5d8 (6) &#39;Test Allocation: 6&#39; 232 232 152</div>
<div class="line">[BLOCK]  0x7fdb7f7cc5d8-0x7fdb7f7cc680 (7) &#39;Test Allocation: 7&#39; 168 136 56</div>
<div class="line">[BLOCK]  0x7fdb7f7cc680-0x7fdb7f7cc7d0 (2) &#39;Test Allocation: 2&#39; 336 336 256</div>
<div class="line">[BLOCK]  0x7fdb7f7cc7d0-0x7fdb7f7cc948 (3) &#39;Test Allocation: 3&#39; 376 0 0</div>
<div class="line">[BLOCK]  0x7fdb7f7cc948-0x7fdb7f7cd000 (4) &#39;Test Allocation: 4&#39; 1720 584 504</div>
<div class="line">[REGION] 0x7fdb7f7a1000-0x7fdb7f7a3000 8192</div>
<div class="line">[BLOCK]  0x7fdb7f7a1000-0x7fdb7f7a3000 (8) &#39;mem_block&#39; 8192 4176 4096</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md3"></a>
Program Options:</h1>
<div class="fragment"><div class="line">LD_PRELOAD=$(pwd)/allocator.so command</div>
<div class="line"> </div>
<div class="line">allocation.h</div>
<div class="line">/* -- Helper functions -- */</div>
<div class="line">void print_memory(void);</div>
<div class="line">void write_memory(FILE * fp);</div>
<div class="line">void *reuse(size_t size);</div>
<div class="line">void *malloc_name(size_t size, char * name);</div>
<div class="line"> </div>
<div class="line">/* -- C Memory API functions -- */</div>
<div class="line">void *malloc(size_t size);</div>
<div class="line">void free(void *ptr);</div>
<div class="line">void *calloc(size_t nmemb, size_t size);</div>
<div class="line">void *realloc(void *ptr, size_t size);</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md4"></a>
Data Structures and Globals:</h1>
<div class="fragment"><div class="line">/**</div>
<div class="line"> * Defines metadata structure for both memory &#39;regions&#39; and &#39;blocks.&#39; This</div>
<div class="line"> * structure is prefixed before each allocation&#39;s data area.</div>
<div class="line"> */</div>
<div class="line">struct mem_block {</div>
<div class="line">    /**</div>
<div class="line">     * Each allocation is given a unique ID number. If an allocation is split in</div>
<div class="line">     * two, then the resulting new block will be given a new ID.</div>
<div class="line">     */</div>
<div class="line">    unsigned long alloc_id;</div>
<div class="line"> </div>
<div class="line">    /**</div>
<div class="line">     * The name of this memory block. If the user doesn&#39;t specify a name for the</div>
<div class="line">     * block, it should be auto-generated based on the allocation ID.</div>
<div class="line">     */</div>
<div class="line">    char name[32];</div>
<div class="line"> </div>
<div class="line">    /** Size of the memory region */</div>
<div class="line">    size_t size;</div>
<div class="line"> </div>
<div class="line">    /** Space used; if usage == 0, then the block has been freed. */</div>
<div class="line">    size_t usage;</div>
<div class="line"> </div>
<div class="line">    /**</div>
<div class="line">     * Pointer to the start of the mapped memory region. This simplifies the</div>
<div class="line">     * process of finding where memory mappings begin.</div>
<div class="line">     */</div>
<div class="line">    struct mem_block *region_start;</div>
<div class="line"> </div>
<div class="line">    /**</div>
<div class="line">     * If this block is the beginning of a mapped memory region, the region_size</div>
<div class="line">     * member indicates the size of the mapping. In subsequent (split) blocks,</div>
<div class="line">     * this is undefined.</div>
<div class="line">     */</div>
<div class="line">    size_t region_size;</div>
<div class="line"> </div>
<div class="line">    /** Next block in the chain */</div>
<div class="line">    struct mem_block *next;</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"> </div>
<div class="line">static struct mem_block *g_head = NULL; /*!&lt; Start (head) of our linked list */</div>
<div class="line">static unsigned long g_allocations = 0; /*!&lt; Allocation counter */</div>
</div><!-- fragment --><p>To compile and use the allocator:</p>
<div class="fragment"><div class="line">make</div>
<div class="line">LD_PRELOAD=$(pwd)/allocator.so ls /</div>
</div><!-- fragment --><p>(in this example, the command <code>ls /</code> is run with the custom memory allocator instead of the default).</p>
<div class="fragment"><div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so ls /</div>
<div class="line">bin  boot  dev  etc  home  lib  lib64  mnt  opt  proc  root  run  sbin  secret  srv  sys  tmp  usr  var</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md5"></a>
Testing</h1>
<p>To execute the test cases, use <code>make test</code>. To pull in updated test cases, run <code>make testupdate</code>. You can also run a specific test case instead of all of them: </p><div class="fragment"><div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ make test</div>
<div class="line">./tests/run_tests</div>
<div class="line">Building test programs</div>
<div class="line">make[1]: Entering directory &#39;/home/alhanson/projects/prj3/P3-alhanson7210/tests/progs&#39;</div>
<div class="line">make[1]: Nothing to be done for &#39;all&#39;.</div>
<div class="line">make[1]: Leaving directory &#39;/home/alhanson/projects/prj3/P3-alhanson7210/tests/progs&#39;</div>
<div class="line">Running Tests: (v9)</div>
<div class="line"> * 01 ls                   [1 pts]  [  OK  ]</div>
<div class="line"> * 02 Free                 [1 pts]  [  OK  ]</div>
<div class="line"> * 03 Basic First Fit      [1 pts]  [  OK  ]</div>
<div class="line"> * 04 Basic Best Fit       [1 pts]  [  OK  ]</div>
<div class="line"> * 05 Basic Worst Fit      [1 pts]  [  OK  ]</div>
<div class="line"> * 06 First Fit            [1 pts]  [  OK  ]</div>
<div class="line"> * 07 Best Fit             [1 pts]  [  OK  ]</div>
<div class="line"> * 08 Worst Fit            [1 pts]  [  OK  ]</div>
<div class="line"> * 09 Scribbling           [1 pts]  [  OK  ]</div>
<div class="line"> * 10 Thread Safety        [1 pts]  [ FAIL ]</div>
<div class="line"> * 11 print_memory()       [1 pts]  [  OK  ]</div>
<div class="line"> * 12 write_memory()       [1 pts]  [  OK  ]</div>
<div class="line"> * 13 Unix Utilities       [1 pts]  [ FAIL ]</div>
<div class="line"> * 15 Static Analysis      [1 pts]  [  OK  ]</div>
<div class="line"> * 16 Documentation        [1 pts]  [  OK  ]</div>
<div class="line"> * 17 Thanks for Trying    [1 pts]  [  OK  ]</div>
<div class="line">Execution complete. [14/16 pts] (87.5%)</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md6"></a>
Program Output</h1>
<div class="fragment"><div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so ls -lrt</div>
<div class="line">total 5332</div>
<div class="line">-rw-r--r-- 1 alhanson alhanson     642 Nov  5 13:58 README.md</div>
<div class="line">-rw-r--r-- 1 alhanson alhanson    2135 Nov  5 13:58 debug.h</div>
<div class="line">-rw-r--r-- 1 alhanson alhanson    2053 Nov 20 02:53 allocator.h</div>
<div class="line">drwxr-xr-x 4 alhanson alhanson    4096 Nov 20 20:21 tests</div>
<div class="line">-rw-r--r-- 1 alhanson alhanson   23688 Nov 20 22:06 allocator.c</div>
<div class="line">-rw-r--r-- 1 alhanson alhanson     552 Nov 20 22:11 Makefile</div>
<div class="line">-rwxr-xr-x 1 alhanson alhanson   24432 Nov 20 22:11 allocator.so</div>
<div class="line">drwxr-xr-x 5 alhanson alhanson      42 Nov 20 22:11 docs</div>
<div class="line">-rw-r--r-- 1 alhanson alhanson     595 Nov 20 22:11 test-memory-output-file.txt</div>
<div class="line">-rw-r--r-- 1 alhanson alhanson 3062864 Nov 20 22:11 allocator.h.gch</div>
<div class="line">-rw-r--r-- 1 alhanson alhanson 2258224 Nov 20 22:11 debug.h.gch</div>
<div class="line">-rwxr-xr-x 1 alhanson alhanson   29592 Nov 20 22:11 a.out</div>
<div class="line">-rw-r--r-- 1 alhanson alhanson   25461 Nov 20 22:11 test-output.md</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so free</div>
<div class="line">              total        used        free      shared  buff/cache   available</div>
<div class="line">Mem:        1008272       77156      807652         400      123464      797800</div>
<div class="line">Swap:             0           0           0</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so getconf PAGE_SIZE</div>
<div class="line">4096</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so echo &quot;code works, what!!!!!!!!!&quot;</div>
<div class="line">LD_PRELOAD=./allocator.so echo &quot;code works, whatLD_PRELOAD=./allocator.so getconf PAGE_SIZELD_PRELOAD=./allocator.so getconf PAGE_SIZELD_PRELOAD=./allocator.so getconf PAGE_SIZELD_PRELOAD=./allocator.so getconf PAGE_SIZE!&quot;</div>
<div class="line">code works, whatLD_PRELOAD=./allocator.so getconf PAGE_SIZELD_PRELOAD=./allocator.so getconf PAGE_SIZELD_PRELOAD=./allocator.so getconf PAGE_SIZELD_PRELOAD=./allocator.so getconf PAGE_SIZE!</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so ls /</div>
<div class="line">bin  boot  dev  etc  home  lib  lib64  mnt  opt  proc  root  run  sbin  secret  srv  sys  tmp  usr  var</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so ps</div>
<div class="line">  PID TTY          TIME CMD</div>
<div class="line"> 2673 pts/0    00:00:01 bash</div>
<div class="line">32137 pts/0    00:00:00 ps</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so touch power_move.txt</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so ls</div>
<div class="line">allocator.c  allocator.h.gch  a.out    debug.h.gch  Makefile        README.md                    test-output.md</div>
<div class="line">allocator.h  allocator.so     debug.h  docs         power_move.txt  test-memory-output-file.txt  tests</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so rm power_move.txt</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$ LD_PRELOAD=./allocator.so ls</div>
<div class="line">allocator.c  allocator.h  allocator.h.gch  allocator.so  a.out  debug.h  debug.h.gch  docs  Makefile  README.md  test-memory-output-file.txt  test-output.md  tests</div>
<div class="line">[alhanson@alhanson7210 P3-alhanson7210]$</div>
</div><!-- fragment --><h1><a class="anchor" id="autotoc_md7"></a>
Running one or multiple cases:</h1>
<div class="fragment"><div class="line"># Run all test cases:</div>
<div class="line">make test</div>
<div class="line"> </div>
<div class="line"># Run a specific test case:</div>
<div class="line">make test run=4</div>
<div class="line"> </div>
<div class="line"># Run a few specific test cases (4, 8, and 12 in this case):</div>
<div class="line">make test run=&#39;4 8 12&#39;</div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.8.16
</small></address>
</body>
</html>
